pipeline {
    agent { label 'sepia' }

    environment {
        MAAS_URL = "http://refarch-r730xd-01.front.sepia.ceph.com:5240/MAAS"
        VENV_DIR = ".venv"
    }

    stages {

        stage('Setup Python Virtual Environment') {
            steps {
                withCredentials([string(credentialsId: 'maas-api-key', variable: 'MAAS_API_KEY')]) {
                    sh '''#!/bin/bash
                        set -e
                        cd "$WORKSPACE/Jenkins-job/test-2.jenkins"

                        # Clean old venv (if incompatible)
                        if [ -d "$VENV_DIR" ]; then
                          echo "Removing incompatible virtual environment..."
                          rm -rf "$VENV_DIR"
                        fi

                        echo "Creating a fresh Python virtual environment..."
                        python3 -m venv "$VENV_DIR"
                        source "$VENV_DIR/bin/activate"

                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Run Builder Script') {
            steps {
                withCredentials([string(credentialsId: 'maas-api-key', variable: 'MAAS_API_KEY')]) {

                    sh '''#!/bin/bash
                        set -e
                        cd "$WORKSPACE/Jenkins-job/test-2.jenkins"
                        source "$VENV_DIR/bin/activate"

                        echo "Preparing commandâ€¦"

                        # Base command: always include action
                        CMD="python Jenkins_builder-reimage.py --action ${ACTION}"

                        # Add machine if provided
                        if [ ! -z "${MACHINE}" ]; then
                            CMD="$CMD --machine ${MACHINE}"
                        fi

                        # Add OS if provided
                        if [ ! -z "${OS}" ]; then
                            CMD="$CMD --os ${OS}"
                        fi

                        echo "Running builder command:"
                        echo "$CMD"

                        # Execute the final constructed command
                        eval $CMD
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Build finished!'
        }
        failure {
            echo 'Build failed!'
        }
    }
}
